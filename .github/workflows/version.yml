name: Docker Version Release

on:
  create:
    tags:
      - v*

jobs:

  build-binaries:
    name: Build Standalone Binaries (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.12']
    env:
      APP_NAME: qbit-manage
      ENTRY: qbit_manage.py
    steps:
      - name: Check Out Repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Upgrade Pip and install project + PyInstaller
        run: |
          python -m pip install --upgrade pip wheel
          python -m pip install . pyinstaller

      - name: Compute add-data separator
        id: sep
        shell: bash
        run: |
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            echo "SEP=;" >> $GITHUB_OUTPUT
          else
            echo "SEP=:" >> $GITHUB_OUTPUT
          fi

      - name: Build (PyInstaller onefile)
        run: |
          ADD_WEBUI="web-ui${{ steps.sep.outputs.SEP }}web-ui"
          ADD_SAMPLE_CFG="config/config.yml.sample${{ steps.sep.outputs.SEP }}config"
          ADD_LOGO="qbm_logo.png${{ steps.sep.outputs.SEP }}."
          pyinstaller --noconfirm \
                      --clean \
                      --onefile \
                      --name "${APP_NAME}" \
                      --add-data "$ADD_WEBUI" \
                      --add-data "$ADD_SAMPLE_CFG" \
                      --add-data "$ADD_LOGO" \
                      "${ENTRY}"

      - name: Rename output for OS
        shell: bash
        run: |
          mkdir -p out
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            mv "dist/${APP_NAME}.exe" "out/${APP_NAME}-windows-amd64.exe"
          elif [[ "${{ runner.os }}" == "macOS" ]]; then
            mv "dist/${APP_NAME}" "out/${APP_NAME}-macos-x86_64"
          else
            mv "dist/${APP_NAME}" "out/${APP_NAME}-linux-amd64"
          fi

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-${{ runner.os }}
          path: out/*

  docker-develop:
    runs-on: ubuntu-latest
    needs: build-binaries

    steps:
      - name: set lower case owner name
        run: |
          echo "OWNER_LC=${OWNER,,}" >>${GITHUB_ENV}
        env:
          OWNER: '${{ github.repository_owner }}'

      - name: Check Out Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Login to ghcr.io
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ env.OWNER_LC }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all

      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v3

      - name: Get the version
        id: get_version
        run: echo "VERSION=${GITHUB_REF/refs\/tags\//}" >> $GITHUB_OUTPUT

      - name: Build and push
        id: docker_build
        uses: docker/build-push-action@v6
        with:
          context: ./
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64,linux/arm/v7
          push: true
          tags: |
            ${{ secrets.DOCKER_HUB_USERNAME }}/qbit_manage:${{ steps.get_version.outputs.VERSION }}
            ghcr.io/${{ env.OWNER_LC }}/qbit_manage:${{ steps.get_version.outputs.VERSION }}

      - name: Download all binary artifacts
        uses: actions/download-artifact@v4
        with:
          path: collected

      - name: Create release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          body_path: CHANGELOG
          token: ${{ secrets.PAT }}
          tag_name: ${{ steps.get_version.outputs.VERSION }}
          files: |
            collected/**/*
      - name: Trigger Hotio Webhook
        uses: joelwmale/webhook-action@master
        with:
          url: ${{ secrets.HOTIO_WEBHOOK_URL }}
          headers: '{"Authorization": "Bearer ${{ secrets.HOTIO_WEBHOOK_SECRET }}"}'
          body: '{ "application": "qbitmanage", "branch":  "release" }'
